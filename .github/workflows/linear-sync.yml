name: GitHub ↔ Linear Sync

on:
  issues:
    types: [opened, labeled, edited]
  issue_comment:
    types: [created]

jobs:
  sync-to-linear:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'linear-sync')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'linear-sync'))

    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Check if Linear issue already exists
        id: check_linear
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });

            const linearComment = comments.data.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Linear Issue:')
            );

            if (linearComment) {
              const match = linearComment.body.match(/https:\/\/linear\.app\/[^\/]+\/issue\/([^\s\)]+)/);
              if (match) {
                core.setOutput('linear_issue_id', match[1]);
                core.setOutput('exists', 'true');
                return;
              }
            }
            core.setOutput('exists', 'false');

      - name: Get Linear team ID
        if: steps.check_linear.outputs.exists == 'false'
        id: get_team
        run: |
          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { teams { nodes { id name } } }"
            }')

          echo "Linear teams:"
          echo "$RESPONSE" | jq -r '.data.teams.nodes[] | "\(.id) - \(.name)"'

          # Get first team ID (you can modify this to select a specific team)
          TEAM_ID=$(echo "$RESPONSE" | jq -r '.data.teams.nodes[0].id')
          echo "team_id=$TEAM_ID" >> $GITHUB_OUTPUT

      - name: Create Linear issue
        if: steps.check_linear.outputs.exists == 'false'
        id: create_linear
        run: |
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")
          ISSUE_URL="${{ github.event.issue.html_url }}"

          # Create description with link back to GitHub
          DESCRIPTION="**GitHub Issue:** $ISSUE_URL\n\n$ISSUE_BODY"

          # Escape description for JSON
          DESCRIPTION_ESCAPED=$(echo "$DESCRIPTION" | jq -Rs .)

          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"mutation { issueCreate(input: { teamId: \\\"${{ steps.get_team.outputs.team_id }}\\\", title: \\\"$ISSUE_TITLE\\\", description: $DESCRIPTION_ESCAPED }) { success issue { id identifier url } } }\"
            }")

          echo "Linear API response:"
          echo "$RESPONSE" | jq .

          # Extract Linear issue details
          LINEAR_ID=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.id')
          LINEAR_IDENTIFIER=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')
          LINEAR_URL=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.url')

          if [ "$LINEAR_ID" = "null" ]; then
            echo "Error: Failed to create Linear issue"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "linear_id=$LINEAR_ID" >> $GITHUB_OUTPUT
          echo "linear_identifier=$LINEAR_IDENTIFIER" >> $GITHUB_OUTPUT
          echo "linear_url=$LINEAR_URL" >> $GITHUB_OUTPUT

      - name: Add comment linking to Linear
        if: steps.check_linear.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `✅ **Linear Issue:** [${{ steps.create_linear.outputs.linear_identifier }}](${{ steps.create_linear.outputs.linear_url }})\n\nThis GitHub issue is now synced with Linear. Updates will be synchronized automatically.`
            });

      - name: Sync comment to Linear
        if: |
          github.event_name == 'issue_comment' &&
          steps.check_linear.outputs.exists == 'true' &&
          github.event.comment.user.login != 'github-actions[bot]'
        run: |
          COMMENT_BODY=$(jq -r '.comment.body' "$GITHUB_EVENT_PATH")
          COMMENT_USER=$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")
          COMMENT_URL="${{ github.event.comment.html_url }}"

          # Create comment with attribution
          LINEAR_COMMENT="**Comment by @$COMMENT_USER on GitHub:** $COMMENT_URL\n\n$COMMENT_BODY"
          LINEAR_COMMENT_ESCAPED=$(echo "$LINEAR_COMMENT" | jq -Rs .)

          curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"mutation { commentCreate(input: { issueId: \\\"${{ steps.check_linear.outputs.linear_issue_id }}\\\", body: $LINEAR_COMMENT_ESCAPED }) { success comment { id } } }\"
            }"
